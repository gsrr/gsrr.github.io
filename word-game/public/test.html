<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title id="pageTitle">Story Test</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  <style>
    body { font-family: 'Poppins', sans-serif; background:#f0f9f6; }
    h1 { font-size:28px; font-weight:700;
         background:linear-gradient(90deg,#3b82f6,#22c55e);
         -webkit-background-clip:text; -webkit-text-fill-color:transparent;
         text-shadow:2px 2px 6px rgba(0,0,0,0.1); }
    .phase-light { display:inline-block; width:20px; height:20px; border-radius:50%;
      margin:0 8px; border:1px solid #ccc; cursor:pointer; }
    .light-pass { background:#22c55e; }
    .light-fail { background:#ef4444; }
    .light-done { background:#facc15; }
    .light-default { background:#e5e7eb; }
    .option-btn { width:100%; font-size:20px; font-weight:600; }
    .wrong-answer { background:#ffe6e6 !important; border-color:#ef4444 !important; }
    .correct-answer { background:#e6ffe6 !important; border-color:#22c55e !important; }
    .image-frame { width:100%; max-height:300px; display:flex; align-items:center; justify-content:center;
      background:transparent; border-radius:6px; border:2px solid #dee2e6; }
    .image-frame img { max-width:100%; max-height:300px; object-fit:contain; }
    .card.correct { border:3px solid #22c55e !important; }
    .card.wrong { border:3px solid #ef4444 !important; }
  </style>
</head>
<body>
  <div id="gameContainer" class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 id="storyTitle">Story Test</h1>
      <button class="btn btn-outline-secondary" onclick="exitToList()">‚Üê Back</button>
    </div>

    <!-- Phase ÁáàËôü -->
    <div class="d-flex flex-column align-items-center mb-4" id="phaseIndicator">
      <div>
        <span id="phase1" class="phase-light" onclick="selectPhase(1)" title="Phase 1"></span>
        <span id="phase2" class="phase-light" onclick="selectPhase(2)" title="Phase 2"></span>
        <span id="phase3" class="phase-light" onclick="selectPhase(3)" title="Phase 3"></span>
      </div>
      <div id="statusBar" class="mt-3 w-100 text-center"></div>
    </div>

    <div id="phaseContent"></div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const story = urlParams.get("story");
    document.title = story ? story : "Story Test";
    document.getElementById("storyTitle").textContent = story;

    let phase = 1;
    let questions = [];
    let current = 0, correctCount = 0, wrongCount = 0;
    let currentAnswerIndex = -1, locked = false;
    let allWords = []; // Phase3 Áî®

    const synth = new Tone.Synth().toDestination();
    function playCorrectSound(){synth.triggerAttackRelease("C6","8n");}
    function playWrongSound(){synth.triggerAttackRelease("C3","8n");setTimeout(()=>synth.triggerAttackRelease("C2","8n"),150);}
    function speak(text){speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(text); u.lang="en-US"; u.rate=0.9; u.pitch=1.1; speechSynthesis.speak(u);}
    function speakAllOptions(q){speechSynthesis.cancel(); q.options.forEach((opt,idx)=>{const u=new SpeechSynthesisUtterance(opt.replace(/_/g," "));u.lang="en-US";u.rate=0.9;u.pitch=1.1;setTimeout(()=>speechSynthesis.speak(u),idx*1200);});}

    function getStoryResults(){return JSON.parse(localStorage.getItem("storyPhases")||"{}");}
    function setPhaseResult(story, phaseKey, status){const data=getStoryResults(); if(!data[story])data[story]={phase1:"notest",phase2:"notest",phase3:"notest"}; data[story][phaseKey]=status; localStorage.setItem("storyPhases",JSON.stringify(data));}
    function exitToList(){window.location.href="index.html";}
    function updatePhaseIndicator(){const results=getStoryResults()[story]||{phase1:"notest",phase2:"notest",phase3:"notest"};["phase1","phase2","phase3"].forEach(p=>{const el=document.getElementById(p);switch(results[p]){case"pass":el.className="phase-light light-pass";break;case"fail":el.className="phase-light light-fail";break;case"done":el.className="phase-light light-done";break;default:el.className="phase-light light-default";}});}
    function selectPhase(p){speechSynthesis.cancel(); phase=p; current=0; correctCount=0; wrongCount=0; locked=false; if(phase===1)startPhase1(); else if(phase===2)startPhase2(); else startPhase3();}

    function renderStatusBar(q,isPhase2=false,isPhase3=false){
      const progressColor="bg-success";
      document.getElementById("statusBar").innerHTML=`
        <div class="progress mb-2 mx-auto" style="height:20px; max-width:600px;">
          <div class="progress-bar ${progressColor}" role="progressbar" style="width:${((current+1)/questions.length)*100}%"></div>
        </div>
        ${isPhase2?`<p class="fs-4 fw-bold mb-1">${q.word.replace(/_/g," ")}</p>`:""}
        ${isPhase3?`<p class="fs-4 fw-bold mb-1">Say the word for this picture</p>`:""}
        <div class="d-flex justify-content-center align-items-center">
          <span class="me-2">‚úÖ ${correctCount} / ‚ùå ${wrongCount}</span>
        </div>`;
    }

    // ---- Phase 1 ----
    async function startPhase1(){
      updatePhaseIndicator();
      const res=await fetch(`/api/questions/${story}`);
      const data=await res.json();
      questions=data.questions.map(q=>q.phase1);
      allWords=data.questions.map(q=>q.phase1.answer);
      renderPhase1();
    }
    function renderPhase1(){
      if(current>=questions.length){
        let result=wrongCount===0?"pass":"fail";
        setPhaseResult(story,"phase1",result);
        updatePhaseIndicator();
        document.getElementById("phaseContent").innerHTML=`<div class="text-center py-5"><h2>Phase 1 ÁµêÊùüÔºÅ</h2></div>`;
        document.getElementById("statusBar").innerHTML="";
        setTimeout(()=>selectPhase(2),2000);
        return;
      }
      const q=questions[current]; renderStatusBar(q,false);
      document.getElementById("phaseContent").innerHTML=`<div class="row"><div class="col-md-6" id="options"></div><div class="col-md-6 text-center"><div class="card shadow-sm"><div class="card-body p-0"><div class="image-frame"><img id="questionImage" src="${q.img}" alt="Question"></div></div></div></div></div>`;
      const optionsDiv=document.getElementById("options"); currentAnswerIndex=-1; locked=false;
      q.options.forEach((opt,idx)=>{const btn=document.createElement("button"); btn.className="btn btn-outline-success option-btn mb-3 text-start"; btn.textContent=`(${idx+1}) ${opt.replace(/_/g," ")}`; btn.onclick=()=>checkAnswerPhase1(opt,q.answer,idx,btn); optionsDiv.appendChild(btn); if(opt===q.answer)currentAnswerIndex=idx;});
      speakAllOptions(q);
    }
    function checkAnswerPhase1(selected,answer,idx,btn){
      if(locked)return; locked=true;
      const optionButtons=document.querySelectorAll(".option-btn");
      if(selected===answer){correctCount++; playCorrectSound(); current++; renderPhase1();}
      else{wrongCount++; btn.classList.add("wrong-answer"); optionButtons[currentAnswerIndex].classList.add("correct-answer"); playWrongSound(); current++; setTimeout(()=>renderPhase1(),1500);}
    }

    // ---- Phase 2 ----
    async function startPhase2(){
      updatePhaseIndicator();
      const res=await fetch(`/api/questions/${story}`);
      const data=await res.json();
      questions=data.questions.map(q=>q.phase2);
      renderPhase2();
    }
    function renderPhase2(){
      if(current>=questions.length){
        let result=wrongCount===0?"pass":"fail";
        setPhaseResult(story,"phase2",result);
        updatePhaseIndicator();
        document.getElementById("phaseContent").innerHTML=`<div class="text-center py-5"><h2>Phase 2 ÁµêÊùüÔºÅ</h2></div>`;
        document.getElementById("statusBar").innerHTML="";
        setTimeout(()=>selectPhase(3),2000);
        return;
      }
      const q=questions[current]; renderStatusBar(q,true); locked=false;
      document.getElementById("phaseContent").innerHTML=`<div class="row" id="phase2Options"></div>`;
      speak(q.word.replace(/_/g," "));
      const optionsDiv=document.getElementById("phase2Options");
      q.options.forEach((opt,idx)=>{const col=document.createElement("div"); col.className="col-md-3 col-6 mb-4 text-center"; const btn=document.createElement("button"); btn.className="btn p-0 border-0 bg-transparent"; btn.onclick=()=>checkAnswerPhase2(opt,q.answer,btn); btn.innerHTML=`<div class="card shadow-sm"><div class="image-frame"><img src="${opt}" alt="Option ${idx+1}"></div></div>`; col.appendChild(btn); optionsDiv.appendChild(col);});
    }
    function checkAnswerPhase2(selected,answer,btn){
      if(locked)return; locked=true;
      if(selected===answer){correctCount++; playCorrectSound(); btn.querySelector(".card").classList.add("correct"); current++; setTimeout(()=>renderPhase2(),1000);}
      else{wrongCount++; btn.querySelector(".card").classList.add("wrong"); const allCards=document.querySelectorAll("#phase2Options .card"); allCards.forEach(card=>{const img=card.querySelector("img"); if(img&&img.src===answer)card.classList.add("correct");}); playWrongSound(); current++; setTimeout(()=>renderPhase2(),1500);}
    }

    // ---- Phase 3 ----
    async function startPhase3(){
      updatePhaseIndicator();
      const res=await fetch(`/api/questions/${story}`);
      const data=await res.json();
      questions=data.questions.map(q=>({ img:q.phase1.img, answer:q.phase1.answer }));
      renderPhase3();
    }
    function renderPhase3(){
      if(current>=questions.length){
        let result=wrongCount===0?"pass":"fail";
        setPhaseResult(story,"phase3",result);
        updatePhaseIndicator();
        document.getElementById("phaseContent").innerHTML=`<div class="text-center py-5"><h2>Phase 3 ÁµêÊùüÔºÅ</h2></div>`;
        document.getElementById("statusBar").innerHTML="";
        setTimeout(()=>exitToList(),2000);
        return;
      }
      const q=questions[current]; renderStatusBar(q,false,true);

      // ÈÅ∏ 3 ÂÄãÂπ≤ÊìæË©û
      const distractors = allWords.filter(w => w !== q.answer).sort(()=>0.5-Math.random()).slice(0,3);
      const words = [q.answer, ...distractors].sort(()=>0.5-Math.random());

      document.getElementById("phaseContent").innerHTML=`
        <div class="row">
          <!-- Â∑¶ÈÇäÔºöÊìç‰ΩúÂçÄ -->
          <div class="col-md-4 d-flex flex-column align-items-center">
            <p id="phase3Status" class="mb-3">üîä Listen carefully...</p>
            <!-- ÂñáÂè≠ + ÈåÑÈü≥ ‰∏ÄÂàó -->
            <div class="d-flex justify-content-center gap-3 mb-3">
              <button id="repeatBtn" class="btn btn-outline-secondary btn-lg" title="Repeat Question">üîä</button>
              <button id="recordBtn" class="btn btn-primary btn-lg" title="Start Recording">üé§</button>
            </div>
            <!-- ÈåÑÈü≥ÂõûÊîæËàáÁ¢∫Ë™ç -->
            <div id="reviewControls" class="mt-3 d-none w-100 text-center">
              <audio id="playback" controls class="mb-2 w-100"></audio>
              <div class="d-flex justify-content-center gap-2">
                <button id="okBtn" class="btn btn-success" title="Submit">‚úÖ</button>
                <button id="redoBtn" class="btn btn-warning" title="Redo">üîÑ</button>
              </div>
            </div>
          </div>
          <!-- Âè≥ÈÇäÔºöÂúñÁâá -->
          <div class="col-md-8">
            <div class="image-frame mb-3"><img src="${q.img}" alt="Phase3"></div>
          </div>
        </div>
        <p id="resultText" class="mt-3 text-center"></p>
      `;

      // ---- È°åÁõÆÁôºÈü≥Ôºà4 ÂÄãÂ≠óÔºâ----
      let idx=0;
      function speakWord(){
        if(idx>=words.length){
          document.getElementById("phase3Status").textContent="Now, say the word for this picture!";
          return;
        }
        const u=new SpeechSynthesisUtterance(words[idx].replace(/_/g," "));
        u.lang="en-US"; u.rate=0.9; u.pitch=1.1;
        u.onend=()=>{idx++; setTimeout(speakWord,800);};
        speechSynthesis.speak(u);
      }
      speakWord();

      // ---- ÈáçËÅΩÈ°åÁõÆ ----
      document.getElementById("repeatBtn").onclick=()=>{
        speechSynthesis.cancel();
        const u=new SpeechSynthesisUtterance(q.answer.replace(/_/g," "));
        u.lang="en-US"; u.rate=0.9; u.pitch=1.1;
        speechSynthesis.speak(u);
      };

      // ---- ÈåÑÈü≥ÊµÅÁ®ã ----
      const recordBtn=document.getElementById("recordBtn");
      const reviewDiv=document.getElementById("reviewControls");
      const playback=document.getElementById("playback");
      let mediaRecorder,audioChunks=[],audioBlob=null;

      recordBtn.onclick=async()=>{
        if(!mediaRecorder||mediaRecorder.state==="inactive"){
          const stream=await navigator.mediaDevices.getUserMedia({audio:true});
          mediaRecorder=new MediaRecorder(stream);
          audioChunks=[];
          mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
          mediaRecorder.onstop=()=>{
            audioBlob=new Blob(audioChunks,{type:"audio/webm"});
            playback.src=URL.createObjectURL(audioBlob);
            reviewDiv.classList.remove("d-none");
          };
          mediaRecorder.start();
          recordBtn.textContent="‚èπ";
        } else {
          mediaRecorder.stop();
          recordBtn.textContent="üé§";
        }
      };

      // ---- Redo ----
      document.getElementById("redoBtn").onclick=()=>{
        reviewDiv.classList.add("d-none");
        playback.src="";
        audioBlob=null;
      };

      // ---- OK (Submit) ----
      document.getElementById("okBtn").onclick=async()=>{
        if(!audioBlob)return;
        const formData=new FormData();
        formData.append("audio",audioBlob,"voice.webm");
        formData.append("words",JSON.stringify(words));
        const resp=await fetch(`/api/speech-match/${story}`,{method:"POST",body:formData});
        const result=await resp.json();
        const best=result.best_match;
        const isCorrect=(best===q.answer);
        document.getElementById("resultText").textContent=isCorrect?`‚úÖ Correct! (${best})`:`‚ùå Wrong! You said: ${best}`;
        if(isCorrect){correctCount++; playCorrectSound();} else {wrongCount++; playWrongSound();}
        current++; setTimeout(()=>renderPhase3(),2000);
      };
    }

    updatePhaseIndicator(); selectPhase(1);
  </script>
</body>
</html>

