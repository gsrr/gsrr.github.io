<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title id="pageTitle">Story Test</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background:#f0f9f6; }
    h1 { font-size:28px; font-weight:700;
         background:linear-gradient(90deg,#3b82f6,#22c55e);
         -webkit-background-clip:text; -webkit-text-fill-color:transparent;
         text-shadow:2px 2px 6px rgba(0,0,0,0.1); }
    .option-btn { width:100%; font-size:20px; font-weight:600; }
    .wrong-answer { background:#ffe6e6 !important; border-color:#ef4444 !important; }
    .correct-answer { background:#e6ffe6 !important; border-color:#22c55e !important; }
    .image-frame { width:100%; max-height:300px; display:flex; align-items:center; justify-content:center; background:transparent; border-radius:6px; border:2px solid #dee2e6; }
    .image-frame img { max-width:100%; max-height:300px; object-fit:contain; }
  </style>
</head>
<body>
  <div id="gameContainer" class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 id="storyTitle">Story Test</h1>
      <button class="btn btn-outline-secondary" onclick="exitToList()">â† Back</button>
    </div>

    <div class="row justify-content-center mb-4">
      <div class="col-md-6">
        <div class="progress" style="height: 20px;">
          <div id="progressFill" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width:0%"></div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6" id="options"></div>
      <div class="col-md-6 text-center">
        <div class="card shadow-sm">
          <div class="card-body p-0">
            <div class="image-frame">
              <img id="questionImage" src="" alt="Question">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- åˆ†æ•¸ -->
    <div class="row justify-content-center mt-4">
      <div class="col-md-6">
        <div class="card shadow-sm text-center">
          <div class="card-body d-flex justify-content-center align-items-center gap-3">
            <button class="btn btn-primary btn-lg rounded-circle" onclick="replayOptions()">ğŸ”Š</button>
            <div id="score" class="fs-4 fw-bold"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const story = urlParams.get("story");

    document.title = story ? story : "Story Test";
    document.getElementById("storyTitle").textContent = story;

    let questions = [];
    let current = 0, correctCount = 0, wrongCount = 0;
    let currentSpeakText = "", currentAnswerIndex = -1, locked = false;

    const synth = new Tone.Synth().toDestination();
    function playCorrectSound() { synth.triggerAttackRelease("C6", "8n"); }
    function playWrongSound() {
      synth.triggerAttackRelease("C3", "8n");
      setTimeout(() => synth.triggerAttackRelease("C2", "8n"), 150);
    }

    function speak(text) {
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "en-US"; utter.rate = 0.9; utter.pitch = 1.1;
      speechSynthesis.speak(utter);
    }
    function replayOptions() {
      if (currentSpeakText) { speechSynthesis.cancel(); speak(currentSpeakText); }
    }

    // å„²å­˜çµæœåˆ° localStorage
    function setResult(story, status) {
      const results = JSON.parse(localStorage.getItem("storyResults") || "{}");
      results[story] = status;
      localStorage.setItem("storyResults", JSON.stringify(results));
    }

    // ææ—©é€€å‡º â†’ In progress
    function exitToList() {
      setResult(story, "done"); // é»ƒè‰²: In progress
      window.location.href = "index.html";
    }

    async function loadStory() {
      const res = await fetch(`/api/questions/${story}`);
      const data = await res.json();
      questions = data.questions;
      current = 0; correctCount = 0; wrongCount = 0;
      showQuestion();
    }

    function showQuestion() {
      if (current >= questions.length) {
        // âœ… åˆ¤æ–·å®Œæˆçµæœ
        let result;
        if (wrongCount === 0) {
          result = "pass";   // å…¨å°
        } else {
          result = "fail";   // åªè¦æœ‰éŒ¯ â†’ Failed
        }

        setResult(story, result);

        document.getElementById("gameContainer").innerHTML = `
          <div class="text-center py-5">
            <h2>ğŸ‰ Game Over!</h2>
            <p class="fs-4 text-success">âœ… Correct: ${correctCount}</p>
            <p class="fs-4 text-danger">âŒ Wrong: ${wrongCount}</p>
            <a href="index.html" class="btn btn-lg btn-primary mt-3">Back to Stories</a>
          </div>
        `;
        return;
      }

      const q = questions[current];
      document.getElementById("questionImage").src = q.img;
      document.getElementById("progressFill").style.width = ((current+1)/questions.length)*100 + "%";

      const optionsDiv = document.getElementById("options");
      optionsDiv.innerHTML = "";
      currentSpeakText = ""; currentAnswerIndex = -1; locked = false;

      q.options.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.className = "btn btn-outline-success option-btn mb-3 text-start";
        btn.textContent = `(${idx+1}) ${opt.replace(/_/g," ")}`;
        btn.onclick = () => checkAnswer(opt, q.answer, idx, btn);
        optionsDiv.appendChild(btn);
        currentSpeakText += `${idx+1}. ${opt.replace(/_/g," ")}. `;
        if (opt === q.answer) currentAnswerIndex = idx;
      });

      updateScore();
      speechSynthesis.cancel();
      setTimeout(() => replayOptions(), current===0 ? 1000 : 500);
    }

    function checkAnswer(selected, answer, idx, btn) {
      if (locked) return;
      locked = true;
      const optionButtons = document.querySelectorAll(".option-btn");
      if (selected === answer) {
        correctCount++; playCorrectSound();
        updateScore(); current++; showQuestion();
      } else {
        wrongCount++;
        btn.classList.add("wrong-answer");
        optionButtons[currentAnswerIndex].classList.add("correct-answer");
        playWrongSound();
        speechSynthesis.cancel();
        speak(`The correct answer is number ${currentAnswerIndex+1}. ${answer.replace(/_/g," ")}.`);
        updateScore(); current++;
        setTimeout(() => showQuestion(), 2000);
      }
    }

    function updateScore() {
      document.getElementById("score").innerHTML =
        `<span class="text-success">âœ… ${correctCount}</span>
         <span class="text-danger">âŒ ${wrongCount}</span>
         <span class="text-primary">ğŸ“Š ${current}/${questions.length}</span>`;
    }

    loadStory();
  </script>
</body>
</html>

