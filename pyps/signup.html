<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ´»å‹•å ±åè¡¨ï½œåœ‹æ¨‚ç¤¾æ ¡å¤–å±•æ¼”æš¨å°äººåœ‹åƒè¨ª</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Noto Sans TC',sans-serif;
  background:#f4f7fb;
  padding:20px;
}
form{
  max-width:720px;
  margin:auto;
  background:#fff;
  padding:36px;
  border-radius:24px;
  box-shadow:0 12px 30px rgba(0,0,0,.1);
}
h1{text-align:center;margin-bottom:28px;}
.section{margin-bottom:32px;}
.section h2{
  font-size:1.3rem;
  margin-bottom:14px;
  color:#2d6a4f;
}
label{
  display:block;
  margin:10px 0 6px;
  font-weight:500;
}
input, select, textarea{
  width:100%;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid #ccc;
  font-size:1rem;
}
.inline{
  display:flex;
  gap:14px;
  flex-wrap:wrap;
}
.inline > div{
  flex:1;
  min-width:160px;
}
button{
  padding:14px 20px;
  font-size:1rem;
  background:#ff6f61;
  color:#fff;
  border:none;
  border-radius:999px;
  cursor:pointer;
  box-shadow:0 6px 18px rgba(255,111,97,.45);
}
button.remove{
  background:#adb5bd;
  box-shadow:none;
  margin-top:14px;
}
button.remove:hover{
  background:#868e96;
}
.submit-btn{
  width:100%;
  font-size:1.25rem;
}
.person-card{
  border:1px dashed #ccc;
  padding:16px;
  border-radius:14px;
  margin-bottom:16px;
}
.summary{
  background:#f8f9fa;
  padding:20px;
  border-radius:16px;
}
.summary-row{
  display:flex;
  justify-content:space-between;
  margin-bottom:8px;
}
.total{
  font-size:1.5rem;
  font-weight:700;
  text-align:right;
  color:#1b4332;
  margin-top:12px;
}
footer{
  text-align:center;
  margin-top:18px;
  font-size:.85rem;
  color:#888;
}
</style>
</head>

<body>

<form id="signupForm">
<h1>ğŸ  æ´»å‹•å ±åè¡¨</h1>

<!-- åŸºæœ¬è³‡æ–™ -->
<div class="section">
  <h2>ğŸ‘¤ åŸºæœ¬è³‡æ–™</h2>
  <label>å§“å *</label>
  <input type="text" name="name" required>

  <label>è¯çµ¡é›»è©± *</label>
  <input type="tel" name="phone" required placeholder="09xxxxxxxx">

  <label>Emailï¼ˆé¸å¡«ï¼‰</label>
  <input type="email" name="email">
</div>

<!-- åƒåŠ äººå“¡ -->
<div class="section">
  <h2>ğŸ« åƒåŠ äººå“¡åå–®</h2>
  <div id="peopleArea"></div>
  <button type="button" id="addPersonBtn">ï¼‹ æ–°å¢ä¸€ä½åƒåŠ è€…</button>
</div>

<!-- ä¾¿ç•¶ -->
<div class="section">
<h2>ğŸ± ä¾¿ç•¶è¨‚è³¼</h2>
<label>æ˜¯å¦ä»£è¨‚ä¾¿ç•¶</label>
<select name="lunch" id="lunchSelect">
  <option value="no">ä¸éœ€è¦</option>
  <option value="yes">éœ€è¦</option>
</select>

<div id="bentoArea" style="display:none;margin-top:16px;">
  <div class="inline">
    <div><label>é›è…¿ $130</label><input type="number" name="bento_chicken" min="0" value="0"></div>
    <div><label>æ’éª¨ $120</label><input type="number" name="bento_pork" min="0" value="0"></div>
  </div>
  <div class="inline">
    <div><label>ç´ é£Ÿ $120</label><input type="number" name="bento_veg" min="0" value="0"></div>
    <div><label>ç‚’é£¯ $100</label><input type="number" name="bento_rice" min="0" value="0"></div>
  </div>
</div>
</div>

<!-- æœ€çµ‚çµ±è¨ˆ -->
<div class="section">
  <h2>ğŸ“Š æœ€çµ‚çµ±è¨ˆ</h2>
  <div class="summary">
    <div class="summary-row"><span>æˆç«¥ç¥¨</span><span id="sumAdult">0</span></div>
    <div class="summary-row"><span>å¹¼ç«¥ç¥¨</span><span id="sumChild">0</span></div>
    <div class="summary-row"><span>åšæ„›ç¥¨</span><span id="sumCare">0</span></div>
    <div class="total" id="totalPrice">$ 0</div>
  </div>
</div>

<button type="submit" class="submit-btn">é€å‡ºå ±å</button>
</form>

<footer>â€» åƒ…ç”¨æ–¼æœ¬æ¬¡æ´»å‹•èˆ‡ä¿éšªç”¨é€”</footer>

<script>
const form = document.getElementById("signupForm");
const peopleArea = document.getElementById("peopleArea");
const addPersonBtn = document.getElementById("addPersonBtn");
const lunchSelect = document.getElementById("lunchSelect");
const bentoArea = document.getElementById("bentoArea");

const sumAdult = document.getElementById("sumAdult");
const sumChild = document.getElementById("sumChild");
const sumCare  = document.getElementById("sumCare");
const totalPriceEl = document.getElementById("totalPrice");

let TICKET_CONF = null;

const BENTO_PRICE = { chicken:130, pork:120, veg:120, rice:100 };

/* è¼‰å…¥ç¥¨åƒ¹è¨­å®š */
async function loadTicketConfig(){
  const res = await fetch("/api/config/ticket");
  if (!res.ok) throw new Error("ticket config load failed");
  TICKET_CONF = await res.json();
}

/* è¨ˆç®—äººæ•¸èˆ‡é‡‘é¡ï¼ˆå‰ç«¯ï¼‰ */
function recalc(){
  const people = [...document.querySelectorAll(".person-card")];
  let count = { adult:0, child:0, care:0 };
  let total = 0;

  people.forEach(p=>{
    const type = p.querySelector("select").value;
    count[type]++;
    if (TICKET_CONF) total += TICKET_CONF.tickets[type].price;
  });

  sumAdult.textContent = count.adult;
  sumChild.textContent = count.child;
  sumCare.textContent  = count.care;

  ["chicken","pork","veg","rice"].forEach(k=>{
    total += Number(form["bento_"+k].value || 0) * BENTO_PRICE[k];
  });

  totalPriceEl.textContent = "$ " + total;
}

/* æ–°å¢åƒåŠ è€… */
addPersonBtn.onclick = ()=>{
  const div = document.createElement("div");
  div.className = "person-card";
  div.innerHTML = `
    <label>å§“å *</label>
    <input required>
    <label>èº«åˆ†è­‰å­—è™Ÿï¼ˆä¿éšªç”¨ï¼‰ *</label>
    <input required>
    <label>èº«åˆ†åˆ¥ *</label>
    <select>
      <option value="adult">æˆç«¥</option>
      <option value="child">å¹¼ç«¥</option>
      <option value="care">åšæ„›</option>
    </select>
    <button type="button" class="remove">ç§»é™¤æ­¤åƒåŠ è€…</button>
  `;
  div.querySelector(".remove").onclick = ()=>{ div.remove(); recalc(); };
  div.onchange = recalc;
  peopleArea.appendChild(div);
  recalc();
};

/* ä¾¿ç•¶é¡¯ç¤º */
lunchSelect.onchange = ()=>{
  bentoArea.style.display = lunchSelect.value === "yes" ? "block" : "none";
};

/* é€å‡ºè¡¨å–® â†’ POST /api/signup */
form.addEventListener("submit", async e=>{
  e.preventDefault();

  const people = [...document.querySelectorAll(".person-card")].map(p=>({
    name: p.querySelector("input:nth-of-type(1)").value.trim(),
    idno: p.querySelector("input:nth-of-type(2)").value.trim(),
    type: p.querySelector("select").value
  }));

  if (people.length === 0) {
    alert("è«‹è‡³å°‘æ–°å¢ä¸€ä½åƒåŠ è€…");
    return;
  }

  const payload = {
    name: form.name.value.trim(),
    phone: form.phone.value.trim(),
    email: form.email.value.trim(),
    people,
    bento: {
      chicken: Number(form.bento_chicken.value||0),
      pork:    Number(form.bento_pork.value||0),
      veg:     Number(form.bento_veg.value||0),
      rice:    Number(form.bento_rice.value||0)
    },
    summary: {
      adult: Number(sumAdult.textContent),
      child: Number(sumChild.textContent),
      care:  Number(sumCare.textContent)
    },
    total: Number(totalPriceEl.textContent.replace(/[^\d]/g,""))
  };

  const res = await fetch("/api/signup",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    alert("âŒ é€å‡ºå¤±æ•—");
    return;
  }

  alert("âœ… å ±åæˆåŠŸ");
  form.reset();
  peopleArea.innerHTML = "";
  recalc();
});

/* åˆå§‹åŒ– */
(async ()=>{
  await loadTicketConfig();
  recalc();
})();
</script>

</body>
</html>

